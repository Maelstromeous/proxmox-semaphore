table inet host_isolation {
  set ssh_allowed_v4 {
    type ipv4_addr
    flags interval
    elements = {
      {% for ip in allowed_ssh_v4 %}
      {{ ip }}{% if not loop.last %}, {% endif %}
      {% endfor %}
    }
  }

  chain input {
    type filter hook input priority 0;
    policy drop;

    iif "lo" accept
    ct state established,related accept

    # Allow DHCP client
    udp sport 67 udp dport 68 accept

    # SSH from allowed hosts
    tcp dport 22 ip saddr @ssh_allowed_v4 counter comment "ALLOW ssh" accept

    # Drop only *new* inbound attempts from 10.0.5.0/24
    ip saddr 10.0.5.0/24 ct state new counter comment "DROP new from 10.0.5.0/24" drop
  }

  chain forward {
    type filter hook forward priority 0;
    policy accept;
  }

  chain output {
    type filter hook output priority 0;
    policy accept; # outbound open (DNS â†’ 1.1.1.1 works)
  }
}